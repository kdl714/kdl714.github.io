<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Filter JSON</title>
<style>
  :root{
    --bg:#0b0b10; --panel:#131320; --muted:#9aa0ac; --text:#e9e9f1; --accent:#5b8cff;
    --stroke:#202036; --field:#0f0f19; --ok:#2ecc71; --err:#ff5c5c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  header{padding:18px 18px;border-bottom:1px solid var(--stroke);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px}
  header .sub{color:var(--muted);font-size:13px}
  .content{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px}
  .content.single{grid-template-columns:1fr}
  @media (max-width: 960px){ .content{grid-template-columns:1fr} }
  .section{display:flex;flex-direction:column;gap:10px;background:transparent}
  .section .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:13px;color:var(--muted)}
  textarea, input[type="text"]{
    width:100%;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:var(--field);color:var(--text)
  }
  textarea{min-height:220px;resize:vertical}
  input[type="file"]{font-size:13px;max-width:100%}
  .btn{
    appearance:none;border:none;padding:10px 14px;border-radius:12px;background:var(--accent);
    color:white;font-weight:600;cursor:pointer
  }
  .btn.secondary{background:#2a2a44;color:#d9d9e6}
  .btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted)}
  .status{font-size:13px;margin-top:6px}
  .status.ok{color:var(--ok)} .status.err{color:var(--err);white-space:pre-wrap}
  .kvs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width: 640px){ .kvs{grid-template-columns:1fr} }
  .tags{display:flex;flex-wrap:wrap;gap:6px}
  code.bubble{background:#101022;padding:2px 6px;border-radius:8px;border:1px solid var(--stroke);font-family:ui-monospace,Consolas,Menlo,monospace}
  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--field);border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid #1e1e30;text-align:left;vertical-align:top}
  th{background:#101022;font-size:12px;color:#bdbdd3;position:sticky;top:0}
  tr:last-child td{border-bottom:none}
  .footer{padding:12px 18px;border-top:1px solid var(--stroke);display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid var(--stroke);background:#101022}
  .chkgrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  @media (max-width: 960px){ .chkgrid{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width: 640px){ .chkgrid{grid-template-columns:1fr} }
  .group{border:1px solid var(--stroke);border-radius:12px;padding:12px;background:#0f0f19}
  .group h3{margin:0 0 8px 0;font-size:13px;color:#bdbdd3}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar .btn{min-width:130px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Filter Users by <code class="bubble">role_members[].account_name</code></h1>
      <div class="sub">No installs • Everything runs locally in your browser</div>
    </header>

    <!-- Input panels -->
    <div class="content">
      <div class="section">
        <label>1) Load JSON (choose one):</label>
        <div class="row">
          <input id="fileInput" type="file" accept=".json,application/json" />
          <button class="btn ghost" id="clearBtn" title="Clear inputs">Clear</button>
        </div>
        <textarea id="jsonText" placeholder='Paste JSON here. Expected shape: { "users": [ ... ] }'></textarea>
        <div class="hint">Tip: For very large files, the file picker is faster than pasting.</div>
      </div>

      <div class="section">
        <label>2) Matching account names (comma-separated)</label>
        <input id="allowedInput" type="text" placeholder='e.g. 0♔ Admin ♔0, Some Other Account'>
        <div class="row">
          <label><input id="caseInsensitive" type="checkbox"> Case-insensitive</label>
          <label><input id="exactMatch" type="checkbox" checked> Exact match</label>
          <label><input id="explodeRows" type="checkbox"> One row per match (flatten)</label>
        </div>

        <div class="group">
          <h3>3) Output fields (auto-detected after loading JSON)</h3>
          <div class="kvs">
            <div>
              <div class="hint" style="margin-bottom:6px;">User fields</div>
              <div id="userFieldGrid" class="chkgrid"></div>
            </div>
            <div>
              <div class="hint" style="margin-bottom:6px;">role_members fields</div>
              <div id="rmFieldGrid" class="chkgrid"></div>
            </div>
          </div>
          <div class="hint" style="margin-top:6px">Default selection: <code class="bubble">id</code>, <code class="bubble">email</code>, <code class="bubble">display_name</code>, <code class="bubble">account_name</code>, <code class="bubble">role</code>.</div>
        </div>

        <div class="toolbar" style="margin-top:8px;">
          <button class="btn" id="runBtn">Run Filter</button>
          <button class="btn secondary" id="downloadJsonBtn" disabled>Download JSON</button>
          <button class="btn secondary" id="downloadCsvBtn" disabled>Download CSV</button>
          <button class="btn ghost" id="copyBtn" disabled>Copy JSON</button>
        </div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="content single">
      <div class="section">
        <label>Results</label>
        <div class="tags hint">
          <span>Showing selectable fields. Toggle “One row per match” to flatten nested <code class="bubble">role_members</code>.</span>
        </div>
        <div style="overflow:auto;max-height:55vh;border-radius:12px">
          <table id="resultsTable" style="display:none;">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      <span class="hint">All processing happens locally. No data leaves your machine.</span>
      <span class="hint">Found an edge case you want included? Tell me which fields and I’ll wire them up.</span>
    </div>
  </div>
</div>

<script>
(function(){
  // ---- DOM refs
  const fileInput = document.getElementById('fileInput');
  const jsonText = document.getElementById('jsonText');
  const allowedInput = document.getElementById('allowedInput');
  const caseInsensitive = document.getElementById('caseInsensitive');
  const exactMatch = document.getElementById('exactMatch');
  const explodeRows = document.getElementById('explodeRows');
  const runBtn = document.getElementById('runBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusEl = document.getElementById('status');
  const resultsTable = document.getElementById('resultsTable');
  const theadRow = document.getElementById('theadRow');
  const resultsBody = document.getElementById('resultsBody');
  const downloadJsonBtn = document.getElementById('downloadJsonBtn');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const copyBtn = document.getElementById('copyBtn');
  const userFieldGrid = document.getElementById('userFieldGrid');
  const rmFieldGrid = document.getElementById('rmFieldGrid');

  let lastOutput = [];
  let selectedFields = { user: new Set(['id','email','display_name']), rm: new Set(['account_name','role']) };
  let detectedFields = { user: [], rm: [] };

  // ---- Helpers
  const escapeHtml = (v) => String(v ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  const setStatus = (msg, kind) => { statusEl.textContent = msg || ''; statusEl.className = 'status ' + (kind||''); };
  const setDownloadsEnabled = (on) => { downloadJsonBtn.disabled = downloadCsvBtn.disabled = copyBtn.disabled = !on; };
  const parseAllowed = (input, ci) => new Set((input||'').split(',').map(s=>s.trim()).filter(Boolean).map(s => ci ? s.toLowerCase() : s));
  function isAllowed(allowedSet, name, {ci, exact}) {
    const candidate = ci ? name.toLowerCase() : name;
    if (exact) return allowedSet.has(candidate);
    for (const term of allowedSet) if (candidate.includes(term)) return true;
    return false;
  }

  function detectFields(data){
    detectedFields = { user:[], rm:[] };
    const users = Array.isArray(data?.users) ? data.users : [];
    const sampleUser = users.find(u => u && typeof u === 'object') || {};
    detectedFields.user = Object.keys(sampleUser).filter(k => k !== 'role_members');

    const rms = Array.isArray(sampleUser.role_members) ? sampleUser.role_members : [];
    const sampleRM = rms.find(r => r && typeof r === 'object') || {};
    detectedFields.rm = Object.keys(sampleRM);

    renderFieldSelectors();
  }

  function renderFieldSelectors(){
    userFieldGrid.innerHTML = '';
    rmFieldGrid.innerHTML = '';
    const makeBox = (name, group) => {
      const id = `${group}-${name}`;
      const wrap = document.createElement('label');
      wrap.style.display = 'flex';
      wrap.style.gap = '8px';
      wrap.style.alignItems = 'center';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.id = id;
      cb.checked = selectedFields[group].has(name);
      cb.addEventListener('change', () => {
        if (cb.checked) selectedFields[group].add(name);
        else selectedFields[group].delete(name);
      });
      const span = document.createElement('span');
      span.textContent = name;
      wrap.appendChild(cb); wrap.appendChild(span);
      return wrap;
    };

    detectedFields.user.forEach(k => userFieldGrid.appendChild(makeBox(k,'user')));
    detectedFields.rm.forEach(k => rmFieldGrid.appendChild(makeBox(k,'rm')));
  }

  function buildColumns(){
    // For per-match rows, we flatten rm fields; else we aggregate into matching_accounts
    const userCols = Array.from(selectedFields.user);
    const rmCols = Array.from(selectedFields.rm);
    if (explodeRows.checked && rmCols.length){
      return [...userCols, ...rmCols.map(n => `rm_${n}`)];
    }
    // per-user row
    return [...userCols, 'matching_accounts'];
  }

  function toCsv(rows, cols){
    const header = cols.join(',');
    const lines = [header];
    for (const r of rows){
      const fields = cols.map(c => {
        const v = r[c];
        const s = (v === null || v === undefined) ? '' : String(v);
        return /[",\r\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      });
      lines.push(fields.join(','));
    }
    return lines.join('\r\n');
  }

  function renderTable(rows, columns){
    resultsBody.innerHTML = '';
    theadRow.innerHTML = '';
    if (!rows.length){ resultsTable.style.display='none'; return; }
    // header
    const fragHead = document.createDocumentFragment();
    columns.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      fragHead.appendChild(th);
    });
    theadRow.appendChild(fragHead);

    // body
    const frag = document.createDocumentFragment();
    rows.forEach(obj => {
      const tr = document.createElement('tr');
      tr.innerHTML = columns.map(c => `<td>${escapeHtml(obj[c])}</td>`).join('');
      frag.appendChild(tr);
    });
    resultsBody.appendChild(frag);
    resultsTable.style.display = '';
  }

  function makeRows(outputObjects, columns){
    // Convert array of objects into uniform table rows using selected columns
    return outputObjects.map(o => {
      const row = {};
      for (const c of columns) row[c] = (o[c] !== undefined ? o[c] : '');
      return row;
    });
  }

  function buildOutput(users, allowed){
    const out = [];
    const ci = caseInsensitive.checked;
    const exact = exactMatch.checked;
    const wantPerMatch = explodeRows.checked;
    const userKeys = Array.from(selectedFields.user);
    const rmKeys = Array.from(selectedFields.rm);

    for (const u of users){
      const roleMembers = Array.isArray(u?.role_members) ? u.role_members : [];
      const matches = roleMembers.filter(rm => {
        const name = String(rm?.account_name ?? '');
        if (!name) return false;
        return isAllowed(allowed, name, {ci, exact});
      });
      if (!matches.length) continue;

      if (wantPerMatch && rmKeys.length){
        // One output row per matching role_member (flattened)
        for (const m of matches){
          const obj = {};
          for (const k of userKeys) obj[k] = u?.[k] ?? null;
          for (const rk of rmKeys) obj[`rm_${rk}`] = m?.[rk] ?? null;
          out.push(obj);
        }
      } else {
        // One output row per user with aggregated matching_accounts
        const obj = {};
        for (const k of userKeys) obj[k] = u?.[k] ?? null;
        obj['matching_accounts'] = matches.map(m => {
          if (!rmKeys.length) return m?.account_name ?? null;
          // compact object with just selected rm fields
          const o = {};
          for (const rk of rmKeys) o[rk] = m?.[rk] ?? null;
          return o;
        });
        // Present aggregated list as a readable string for table view
        obj['matching_accounts'] = Array.isArray(obj['matching_accounts'])
          ? obj['matching_accounts'].map(v => {
              if (v && typeof v === 'object'){
                // e.g. "account_name (role)"
                const name = v.account_name ?? '';
                const role = v.role ? ` (${v.role})` : '';
                const rest = Object.entries(v)
                  .filter(([k]) => k !== 'account_name' && k !== 'role' && v[k] != null)
                  .map(([k,val]) => `${k}:${val}`).join(', ');
                return [name + role, rest].filter(Boolean).join(rest ? ' — ' : '');
              }
              return String(v ?? '');
            }).join('; ')
          : '';
        out.push(obj);
      }
    }
    return out;
  }

  // ---- Events
  clearBtn.addEventListener('click', () => {
    fileInput.value = '';
    jsonText.value = '';
    allowedInput.value = '';
    caseInsensitive.checked = false;
    exactMatch.checked = true;
    explodeRows.checked = false;
    resultsBody.innerHTML = '';
    document.getElementById('theadRow').innerHTML = '';
    resultsTable.style.display = 'none';
    lastOutput = [];
    setDownloadsEnabled(false);
    setStatus('');
  });

  fileInput.addEventListener('change', async (e) => {
    if (!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    try {
      const text = await file.text();
      jsonText.value = text;
      setStatus(`Loaded file: ${file.name} (${file.size.toLocaleString()} bytes)`, 'ok');
      const data = JSON.parse(text);
      detectFields(data);
    } catch (err) {
      setStatus(`Failed to read file: ${String(err)}`, 'err');
    }
  });

  jsonText.addEventListener('blur', () => {
    // Try to detect fields after manual paste
    try {
      const raw = (jsonText.value || '').trim();
      if (!raw) return;
      const data = JSON.parse(raw);
      detectFields(data);
    } catch (_) {}
  });

  runBtn.addEventListener('click', () => {
    setDownloadsEnabled(false);
    resultsBody.innerHTML = '';
    resultsTable.style.display = 'none';

    const allowed = parseAllowed(allowedInput.value, caseInsensitive.checked);
    if (allowed.size === 0){
      setStatus('Please enter at least one account_name to match.', 'err');
      return;
    }

    let data;
    try{
      const raw = (jsonText.value || '').trim();
      if (!raw) return setStatus('Please load a JSON file or paste JSON into the textbox.', 'err');
      data = JSON.parse(raw);
    }catch(e){ return setStatus('Invalid JSON. Details:\n' + e.message, 'err'); }

    const users = Array.isArray(data?.users) ? data.users : null;
    if (!users) return setStatus('Expected an object with a "users" array at the top level.', 'err');

    const t0 = performance.now();
    const outputObjects = buildOutput(users, allowed);
    const columns = buildColumns();
    const tableRows = makeRows(outputObjects, columns);
    const t1 = performance.now();

    lastOutput = tableRows;
    renderTable(tableRows, columns);
    setDownloadsEnabled(tableRows.length > 0);
    setStatus(`Matched ${tableRows.length.toLocaleString()} row(s) — ${(t1 - t0).toFixed(1)}ms.`, 'ok');
  });

  downloadJsonBtn.addEventListener('click', () => {
    if (!lastOutput.length) return;
    const blob = new Blob([JSON.stringify(lastOutput, null, 2)], {type:'application/json'});
    triggerDownload(blob, 'filtered-users.json');
  });

  copyBtn.addEventListener('click', async () => {
    if (!lastOutput.length) return;
    try{
      await navigator.clipboard.writeText(JSON.stringify(lastOutput, null, 2));
      setStatus('Copied JSON to clipboard.', 'ok');
    }catch(e){ setStatus('Copy failed: ' + e.message, 'err'); }
  });

  downloadCsvBtn.addEventListener('click', () => {
    if (!lastOutput.length) return;
    const cols = buildColumns();
    const csv = toCsv(lastOutput, cols);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    triggerDownload(blob, 'filtered-users.csv');
  });

  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // Initialize empty selectors so layout doesn't jump
  renderFieldSelectors();
})();
</script>
</body>
</html>
