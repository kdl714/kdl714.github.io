<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON Filter & Flatten</title>
  <style>
    :root{
      --bg:#0b0f14;        /* page background */
      --panel:#111826;     /* cards */
      --panel-2:#0f1420;   /* alt panel */
      --muted:#7b8aa1;     /* secondary text */
      --text:#e7eefc;      /* primary text */
      --accent:#6aa9ff;    /* brand */
      --accent-2:#97c1ff;  /* brand alt */
      --bad:#ff6b6b;
      --good:#5ce2a9;
      --border:#1b2433;
      --chip:#1a2333;
      --chip-on:#1d2b43;
      --focus:#1b2b4b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg, var(--bg), #0a0d12 40%, #0a0d12);
      color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px 40px}
    header h1{font-size:22px;margin:0 0 8px;letter-spacing:.2px}
    header p{margin:0;color:var(--muted)}

    /* Stepper */
    .steps{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px 0 16px}
    .step{background:var(--panel);border:1px solid var(--border);padding:12px 14px;border-radius:14px;display:flex;gap:10px;align-items:center;opacity:.85}
    .step.active{background:linear-gradient(180deg,#162236,var(--panel));border-color:#26344d;box-shadow:0 0 0 1px #253144 inset, 0 6px 20px rgba(0,0,0,.25);opacity:1}
    .step .idx{width:22px;height:22px;display:grid;place-items:center;border-radius:7px;background:var(--chip);color:#cfe0ff;font-weight:700}
    .step.active .idx{background:var(--accent);color:#001632}
    .step .lab{font-weight:600}

    /* Panels */
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:1024px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .card h3{margin:0 0 10px;font-size:16px}
    .card .desc{color:var(--muted);font-size:13px;margin:-3px 0 10px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}

    .input, textarea, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel-2);color:var(--text)}
    textarea{min-height:160px;resize:vertical}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 11px;border:1px dashed var(--border);border-radius:12px;background:var(--panel-2);font-size:13px}
    .btn{appearance:none;border:1px solid #26344d;background:#152036;color:#d8e7ff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:hover{background:#1a2743}
    .btn.secondary{background:#121a2b;border-color:var(--border);color:#c7d8f7}
    .btn.bad{background:#2b1515;border-color:#412828;color:#ffd1d1}
    .btn.good{background:#123023;border-color:#184a34;color:#bdf5df}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#a9b7cf}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 9px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:12px}

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

    .toggle{display:inline-flex;gap:8px;align-items:center}
    .toggle input{width:36px;height:22px;-webkit-appearance:none;appearance:none;background:#1e2635;border-radius:999px;position:relative;border:1px solid var(--border);outline:none;cursor:pointer}
    .toggle input:checked{background:#1f334f;border-color:#2a446f}
    .toggle input:before{content:"";position:absolute;left:2px;top:2px;width:16px;height:16px;background:#cfe0ff;border-radius:50%;transition:transform .2s ease}
    .toggle input:checked:before{transform:translateX(14px)}

    /* Field list */
    .fieldlist{max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--panel-2)}
    .field-item{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px}
    .field-item:hover{background:#131c2c}
    .field-item input{flex:0}
    .field-item label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Table */
    .tablewrap{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0f1726;border-bottom:1px solid var(--border);padding:10px 12px;text-align:left;font-size:13px;white-space:nowrap}
    thead th .th-inner{display:flex;align-items:center;gap:8px}
    thead th .drag{opacity:.6;cursor:grab}
    thead th.sortable{cursor:pointer}
    thead th.disabled{opacity:.4}
    tbody td{border-bottom:1px solid #121a2b;padding:8px 12px;vertical-align:top;font-size:13px}
    tbody tr:hover{background:#0f1627}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace;background:#0f1a2c;border:1px solid var(--border);padding:2px 6px;border-radius:6px}

    .status{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}

    footer{margin-top:16px;color:#8ea4c8}
  </style>
  <!-- JSONPath-Plus for JSONPath mode (small UMD build). If offline, Field Filter mode still works. -->
  <script src="https://cdn.jsdelivr.net/npm/jsonpath-plus@7.2.0/dist/index-browser-umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>JSON Filter & Flatten</h1>
      <p class="muted">Load JSON → choose a record root → filter (JSONPath or Field) → pick columns → view live table → export CSV.</p>
    </header>

    <!-- Stepper -->
    <div class="steps" id="stepper">
      <div class="step active" data-step="1"><div class="idx">1</div><div class="lab">Load JSON</div></div>
      <div class="step" data-step="2"><div class="idx">2</div><div class="lab">Define Filter</div></div>
      <div class="step" data-step="3"><div class="idx">3</div><div class="lab">View & Tweak</div></div>
      <div class="step" data-step="4"><div class="idx">4</div><div class="lab">Export</div></div>
    </div>

    <!-- Step 1: Input JSON -->
    <section class="grid" id="step1">
      <div class="card">
        <h3>Provide JSON</h3>
        <p class="desc">Paste JSON or select a .json file. We validate it before continuing.</p>
        <div class="two">
          <div>
            <label class="muted">Paste JSON</label>
            <textarea id="jsonText" placeholder='{"items":[{"id":1,"name":"Alice"}]}'></textarea>
          </div>
          <div>
            <label class="muted">Or Upload .json</label>
            <div class="row">
              <input class="input" type="file" id="jsonFile" accept=".json,application/json" />
            </div>
            <div style="margin-top:10px" class="row">
              <button class="btn secondary" id="loadExample">Load Example</button>
              <button class="btn" id="validateBtn">Validate & Continue</button>
            </div>
            <p id="jsonStatus" class="status" style="margin-top:10px"><span class="dot" id="jsonDot" style="background:#555"></span><span class="hint">No JSON loaded yet.</span></p>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Detected Record Roots</h3>
        <p class="desc">Choose which array-of-objects should be treated as the table's rows.</p>
        <div class="row">
          <select id="rootSelect" disabled></select>
        </div>
        <p class="hint" id="rootHint" style="margin-top:8px">Root options will appear after loading valid JSON.</p>
      </div>
    </section>

    <!-- Step 2: Define Filter -->
    <section class="grid" id="step2" style="display:none">
      <div class="card">
        <h3>Choose Filter Mode</h3>
        <div class="row">
          <label class="pill"><input type="radio" name="mode" value="field" checked> Field filter</label>
          <label class="pill"><input type="radio" name="mode" value="jsonpath"> JSONPath</label>
          <span class="chip" id="jpStatus">JSONPath lib: <strong id="jpAvail">checking…</strong></span>
        </div>
        <div id="fieldMode" style="margin-top:10px">
          <div class="two">
            <div>
              <label class="muted">Field to filter on</label>
              <select id="filterField"></select>
            </div>
            <div>
              <label class="muted">Value(s) (comma-separated)</label>
              <input id="filterValues" class="input" placeholder='e.g. Site 123, Admin' />
            </div>
          </div>
          <p class="hint">Filter is case-insensitive equality against any value found at the chosen path (handles arrays too).</p>
        </div>
        <div id="jsonpathMode" style="display:none;margin-top:10px">
          <label class="muted">JSONPath expression</label>
          <input id="jsonpathInput" class="input" placeholder='e.g. $.users[?(@.role_members[*].account_name=="Site 123")]' />
          <p class="hint">Expression should return an array of objects to be used as the table rows. Root is the whole document (<span class="kbd">$</span>).</p>
        </div>
      </div>
      <div class="card">
        <h3>Pick Columns</h3>
        <p class="desc">Select which fields to display. Toggle visibility; hidden columns are pushed to the end and show no data.</p>
        <div class="row" style="margin-bottom:8px">
          <input id="fieldSearch" class="input" placeholder="Search fields…" />
          <button class="btn secondary" id="selectCommon">Select common</button>
          <button class="btn secondary" id="selectAll">All</button>
          <button class="btn secondary" id="selectNone">None</button>
        </div>
        <div id="fields" class="fieldlist"></div>
      </div>
    </section>

    <!-- Step 3: View Output -->
    <section id="step3" style="display:none">
      <div class="card" style="margin-bottom:10px">
        <div class="row">
          <div class="toggle"><input type="checkbox" id="explodeToggle"/><label for="explodeToggle">Flatten nested arrays into new rows</label></div>
          <div class="toggle"><input type="checkbox" id="caseToggle" checked/><label for="caseToggle">Case-insensitive matching</label></div>
          <div style="flex:1"></div>
          <div class="chip">Rows: <strong id="rowCount">0</strong></div>
          <div class="chip">Columns: <strong id="colCount">0</strong></div>
        </div>
      </div>
      <div class="tablewrap">
        <table id="resultTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Step 4: Export -->
    <section id="step4" style="display:none">
      <div class="card">
        <h3>Export</h3>
        <div class="row">
          <button class="btn good" id="exportCsv">Export visible table to CSV</button>
          <button class="btn secondary" id="resetAll">Start over</button>
        </div>
        <p class="hint" style="margin-top:10px">Export respects current column order, visibility and sorting.</p>
      </div>
    </section>

    <footer>
      Built for quick ad‑hoc JSON inspection and extraction.
    </footer>
  </div>

<script>
(function(){
  // --- Global state ---
  const state = {
    raw: null,              // original parsed object
    rawText: '',
    roots: new Map(),       // path => Array<arrayRef>
    rootPath: null,         // selected root path key in roots, or "<top-array>"
    records: [],            // current record set (array of objects)

    mode: 'field',          // 'field' | 'jsonpath'
    filterField: null,
    filterValues: [],
    caseInsensitive: true,
    jsonpathExpr: '',

    allFields: [],          // list of dot paths (relative to record)
    selectedFields: [],     // visible fields (ordered)
    hiddenFields: new Set(),
    columnsOrder: [],       // all columns order (visible first + hidden tail)

    explode: false,
    sort: { field: null, dir: 1 },
  };

  // --- DOM helpers ---
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const stepEls = $$('#stepper .step');
  const setStep = n => {
    stepEls.forEach(el=>el.classList.toggle('active', +el.dataset.step===n));
    ['#step1','#step2','#step3','#step4'].forEach((id,i)=>{
      const show = (i+1)<=n && (i+1>=n || i+1===3 || i+1===4 ? true : (i+1)===n);
      // Keep prior steps visible for context through step2; show table/export only when reached
      if(i+1<3) $(id).style.display = (i+1<=n)?'grid':'none';
      if(i+1>=3) $(id).style.display = (i+1<=n)?'block':'none';
    });
  };

  // --- JSON utilities ---
  function isObj(x){ return x && typeof x==='object' && !Array.isArray(x); }
  function isPrim(x){ return x==null || typeof x!=='object'; }

  function enumeratePaths(node, prefix='', acc=new Set()){
    if(Array.isArray(node)){
      for(const el of node){ enumeratePaths(el, prefix, acc); }
      return acc;
    }
    if(isObj(node)){
      for(const [k,v] of Object.entries(node)){
        const p = prefix? prefix+'.'+k : k;
        if(isPrim(v)) acc.add(p);
        else enumeratePaths(v, p, acc);
      }
      return acc;
    }
    acc.add(prefix);
    return acc;
  }

  function findArrayObjectPaths(node, prefix='', map){
    if(Array.isArray(node)){
      if(node.length && node.every(el=>isObj(el))){
        const key = prefix || '<top-array>';
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(node);
      }
      for(const el of node) findArrayObjectPaths(el, prefix, map);
      return;
    }
    if(isObj(node)){
      for(const [k,v] of Object.entries(node)){
        const p = prefix? prefix+'.'+k : k;
        findArrayObjectPaths(v, p, map);
      }
    }
  }

  function valuesAt(obj, path){
    const parts = path.split('.');
    let current = [obj];
    for(const part of parts){
      const next = [];
      for(const item of current){
        if(item==null) continue;
        let v = item[part];
        if(Array.isArray(v)) next.push(...v);
        else next.push(v);
      }
      current = next;
    }
    // Flatten to primitives
    const out = [];
    const stack = [...current];
    while(stack.length){
      const v = stack.pop();
      if(Array.isArray(v)) stack.push(...v);
      else if(isObj(v)) out.push(JSON.stringify(v));
      else out.push(v);
    }
    return out.filter(x=>x!==undefined);
  }

  function cartesian(arrays){
    if(!arrays.length) return [[]];
    return arrays.reduce((acc,cur)=>{
      const out=[]; for(const a of acc){ for(const c of cur){ out.push(a.concat([c])) } } return out;
    }, [[]]);
  }

  function normalizeStr(x){
    if(x==null) return '';
    if(typeof x==='string') return x;
    return String(x);
  }

  // --- Rendering Field List ---
  function renderFieldList(){
    const container = $('#fields');
    const q = $('#fieldSearch').value.trim().toLowerCase();
    container.innerHTML='';
    const fields = state.allFields.slice().sort((a,b)=>a.localeCompare(b));
    const frag = document.createDocumentFragment();
    for(const f of fields){
      if(q && !f.toLowerCase().includes(q)) continue;
      const row = document.createElement('div');
      row.className='field-item';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = state.selectedFields.includes(f);
      cb.addEventListener('change',()=>{
        if(cb.checked){
          if(!state.selectedFields.includes(f)) state.selectedFields.push(f);
          state.hiddenFields.delete(f);
        }else{
          state.selectedFields = state.selectedFields.filter(x=>x!==f);
          state.hiddenFields.add(f);
        }
        rebuildColumnsOrder();
        renderTable();
      });
      const lab = document.createElement('label'); lab.textContent=f;
      row.append(cb, lab);
      frag.append(row);
    }
    container.append(frag);
  }

  function rebuildColumnsOrder(){
    // Visible fields first (in selected order), then hidden ones (alphabetical) appended
    const hidden = state.allFields.filter(f=>state.hiddenFields.has(f) && !state.selectedFields.includes(f)).sort((a,b)=>a.localeCompare(b));
    state.columnsOrder = [...state.selectedFields, ...hidden];
  }

  // --- Records + Filtering ---
  function recomputeRecordsFromRoot(){
    const key = state.rootPath;
    if(!key){ state.records=[]; return; }
    const arrays = state.roots.get(key) || [];
    const recs = [];
    for(const arr of arrays){
      for(const item of arr){ if(isObj(item)) recs.push(item); }
    }
    state.records = recs;
    // Compute fields relative to record
    const fieldSet = new Set();
    for(const r of state.records.slice(0, 200)){ // sample for speed
      enumeratePaths(r, '', fieldSet);
    }
    state.allFields = Array.from(fieldSet);
    // initialize selections if empty
    if(state.selectedFields.length===0){
      state.selectedFields = state.allFields.slice(0, Math.min(6, state.allFields.length));
      state.hiddenFields.clear();
      for(const f of state.allFields){ if(!state.selectedFields.includes(f)) state.hiddenFields.add(f); }
      rebuildColumnsOrder();
    }
    // Set a default filter field if not set
    if(!state.filterField && state.allFields.length){ state.filterField = state.allFields.includes('id')? 'id' : state.allFields[0]; }
  }

  function applyFilter(){
    let base = state.records;
    if(state.mode==='jsonpath' && state.jsonpathExpr.trim()){
      const jpFunc = (window.JSONPath && window.JSONPath.JSONPath) ? window.JSONPath.JSONPath : window.JSONPath;
      if(typeof jpFunc === 'function'){
        try{
          const out = jpFunc({ path: state.jsonpathExpr, json: state.raw });
          // Accept array of objects; otherwise ignore
          if(Array.isArray(out) && out.every(x=>isObj(x))){ base = out; }
        }catch(e){ /* ignore parse errors; keep base */ }
      }
    } else if(state.mode==='field' && state.filterField && state.filterValues.length){
      const wanted = state.filterValues;
      const ci = !!state.caseInsensitive;
      base = base.filter(rec=>{
        const vals = valuesAt(rec, state.filterField).map(v=>normalizeStr(v));
        if(ci){
          const set = new Set(vals.map(s=>s.toLowerCase()));
          for(const w of wanted){ if(set.has(w.toLowerCase())) return true; }
          return false;
        } else {
          const set = new Set(vals);
          for(const w of wanted){ if(set.has(w)) return true; }
          return false;
        }
      });
    }
    return base;
  }

  // --- Table Rendering ---
  function renderTable(){
    const visible = state.selectedFields.slice();
    const hidden = state.columnsOrder.filter(c=>!visible.includes(c));

    const thead = $('#resultTable thead');
    const tbody = $('#resultTable tbody');
    thead.innerHTML=''; tbody.innerHTML='';

    // Header row
    const trh = document.createElement('tr');
    const headers = [...visible, ...hidden];

    headers.forEach((col, idx)=>{
      const th = document.createElement('th');
      th.dataset.col = col;
      th.classList.toggle('disabled', hidden.includes(col));
      if(!hidden.includes(col)) th.classList.add('sortable');
      const inner = document.createElement('div');
      inner.className='th-inner';
      const drag = document.createElement('span'); drag.className='drag'; drag.innerHTML='⋮⋮';
      th.draggable = !hidden.includes(col);
      th.addEventListener('dragstart', ev=>{
        ev.dataTransfer.setData('text/plain', String(idx));
      });
      th.addEventListener('dragover', ev=>{ if(!hidden.includes(col)){ ev.preventDefault(); }});
      th.addEventListener('drop', ev=>{
        ev.preventDefault();
        const from = +ev.dataTransfer.getData('text/plain');
        const to = idx;
        // Only allow reorder within visible segment
        const visLen = visible.length;
        if(from<visLen && to<visLen){
          const moved = state.selectedFields.splice(from,1)[0];
          state.selectedFields.splice(to,0,moved);
          rebuildColumnsOrder();
          renderTable();
        }
      });
      th.addEventListener('click', ()=>{
        if(hidden.includes(col)) return;
        if(state.sort.field===col){ state.sort.dir *= -1; } else { state.sort.field=col; state.sort.dir=1; }
        renderTable();
      });
      const lab = document.createElement('span'); lab.textContent = hidden.includes(col) ? col+"  [off]" : col;
      const sortGlyph = document.createElement('span'); sortGlyph.style.opacity = .6;
      if(state.sort.field===col) sortGlyph.textContent = state.sort.dir>0? ' ▲' : ' ▼';
      inner.append(drag, lab, sortGlyph);
      th.append(inner);
      trh.append(th);
    });
    thead.append(trh);

    // Rows
    const base = applyFilter();
    let rows = [];
    for(const rec of base){
      if(state.explode){
        const matrix = visible.map(col => {
          const vals = valuesAt(rec, col).map(v=>normalizeStr(v));
          return vals.length? vals : [''];
        });
        for(const combo of cartesian(matrix)){
          const row = {}; visible.forEach((c,i)=> row[c]=combo[i]); rows.push(row);
        }
      } else {
        const row = {};
        for(const col of visible){
          const vals = valuesAt(rec, col).map(v=>normalizeStr(v));
          row[col] = vals.length>1 ? vals.join(', ') : (vals[0]??'');
        }
        rows.push(row);
      }
    }

    // Sorting
    if(state.sort.field){
      const f = state.sort.field, d = state.sort.dir;
      rows.sort((a,b)=>{
        const A = normalizeStr(a[f]); const B = normalizeStr(b[f]);
        return A.localeCompare(B, undefined, {numeric:true, sensitivity: state.caseInsensitive? 'accent':'variant'}) * d;
      });
    }

    // Render body
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      for(const col of headers){
        const td = document.createElement('td');
        if(visible.includes(col)) td.textContent = r[col] ?? '';
        else td.textContent = '';
        tr.append(td);
      }
      frag.append(tr);
    }
    tbody.append(frag);

    // Counters
    $('#rowCount').textContent = rows.length;
    $('#colCount').textContent = visible.length + hidden.length;
  }

  // --- CSV Export ---
  function exportCSV(){
    const headers = state.columnsOrder.filter(c=>!state.hiddenFields.has(c)); // visible only
    const base = applyFilter();
    const rows = [];
    for(const rec of base){
      if(state.explode){
        const matrix = headers.map(col => {
          const vals = valuesAt(rec, col).map(v=>normalizeStr(v));
          return vals.length? vals : [''];
        });
        for(const combo of cartesian(matrix)){
          const obj = {}; headers.forEach((c,i)=> obj[c]=combo[i]); rows.push(obj);
        }
      } else {
        const obj = {};
        for(const col of headers){
          const vals = valuesAt(rec, col).map(v=>normalizeStr(v));
          obj[col] = vals.length>1 ? vals.join(', ') : (vals[0]??'');
        }
        rows.push(obj);
      }
    }
    // Sort to match UI sort
    if(state.sort.field){
      const f = state.sort.field, d = state.sort.dir;
      rows.sort((a,b)=>{
        const A = normalizeStr(a[f]); const B = normalizeStr(b[f]);
        return A.localeCompare(B, undefined, {numeric:true, sensitivity: state.caseInsensitive? 'accent':'variant'}) * d;
      });
    }

    const esc = v => '"'+ String(v??'').replace(/"/g,'""') +'"';
    const csv = [headers.map(esc).join(',')]
      .concat(rows.map(r=> headers.map(h=>esc(r[h])).join(',')))
      .join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const ts = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `filtered_export_${ts}.csv`;
    document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // --- Wiring ---
  function updateJsonStatus(ok, msg){
    $('#jsonDot').className = 'dot ' + (ok? 'good':'bad');
    $('#jsonStatus .hint').textContent = msg;
  }

  function prepareAfterJsonLoad(){
    // Roots
    state.roots = new Map();
    findArrayObjectPaths(state.raw, '', state.roots);
    const sel = $('#rootSelect'); sel.innerHTML='';
    if(state.roots.size===0){
      $('#rootHint').innerHTML = 'No array-of-objects found. If your root itself is an array of objects, paste it directly.';
      // handle top-level array
      if(Array.isArray(state.raw) && state.raw.every(x=>isObj(x))){
        state.roots.set('<top-array>', [state.raw]);
      }
    }
    // Fill select
    for(const [k, arrs] of state.roots.entries()){
      const opt = document.createElement('option');
      const count = arrs.reduce((n,a)=>n+a.length,0);
      opt.value = k; opt.textContent = `${k}  (${count} items)`;
      sel.append(opt);
    }
    sel.disabled = state.roots.size===0;

    // pick first root
    state.rootPath = state.roots.keys().next().value || null;
    if(state.rootPath){ sel.value = state.rootPath; }

    // compute records & fields
    recomputeRecordsFromRoot();

    // Populate filter field dropdown
    const ff = $('#filterField'); ff.innerHTML='';
    for(const f of state.allFields){ const o=document.createElement('option'); o.value=o.textContent=f; ff.append(o); }
    state.filterField = ff.value;

    // Field list UI
    renderFieldList();
    setStep(2);
    renderTable();
  }

  // Inputs
  $('#jsonFile').addEventListener('change', async (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      state.raw = obj; state.rawText = txt;
      updateJsonStatus(true, `Loaded: ${f.name} (${txt.length.toLocaleString()} chars)`);
      prepareAfterJsonLoad();
    }catch(err){ updateJsonStatus(false, 'Invalid JSON in uploaded file.'); }
  });

  $('#validateBtn').addEventListener('click', ()=>{
    const txt = $('#jsonText').value.trim(); if(!txt){ updateJsonStatus(false,'Please paste JSON or upload a file.'); return; }
    try{
      const obj = JSON.parse(txt);
      state.raw = obj; state.rawText = txt;
      updateJsonStatus(true, `Valid JSON (${txt.length.toLocaleString()} chars)`);
      prepareAfterJsonLoad();
    }catch(err){ updateJsonStatus(false, 'Invalid JSON: ' + err.message); }
  });

  $('#loadExample').addEventListener('click', ()=>{
    const example = `{"users":[{"id":15013,"email":"nodela@zetaglobal.com","first_name":"Narender","last_name":null,"display_name":"Narender Odela","account_id":8437,"org_account_id":1425,"created_at":"2017-08-03T12:35:30.000Z","current_sign_in_at":"2025-08-18T18:01:23.000Z","sign_in_count":508,"is_active":true,"role_members":[{"id":14991,"account_id":1425,"account_name":"Admin","role_id":153,"role":"Acquisition General Access","user_id":15013,"company_name":"Admin","created_at":"2018-12-28T06:50:43.000Z","updated_at":"2023-10-24T17:39:26.000Z"},{"id":137407,"account_id":5617,"account_name":"Site 123","role_id":1,"role":"Super User","user_id":15013,"company_name":"Verizon 1","created_at":"2024-01-25T01:23:35.000Z","updated_at":"2024-01-25T01:23:35.000Z"}]}]}`;
    $('#jsonText').value = example;
  });

  $('#rootSelect').addEventListener('change', (ev)=>{
    state.rootPath = ev.target.value;
    recomputeRecordsFromRoot();
    renderFieldList();
    renderTable();
    setStep(2);
  });

  $('input[name="mode"][value="field"]').addEventListener('change', ()=>{ state.mode='field'; $('#fieldMode').style.display='block'; $('#jsonpathMode').style.display='none'; renderTable(); });
  $('input[name="mode"][value="jsonpath"]').addEventListener('change', ()=>{ state.mode='jsonpath'; $('#fieldMode').style.display='none'; $('#jsonpathMode').style.display='block'; renderTable(); });

  $('#filterField').addEventListener('change', (ev)=>{ state.filterField = ev.target.value; renderTable(); });
  $('#filterValues').addEventListener('input', (ev)=>{ state.filterValues = ev.target.value.split(',').map(s=>s.trim()).filter(Boolean); renderTable(); });
  $('#caseToggle').addEventListener('change', (ev)=>{ state.caseInsensitive = ev.target.checked; renderTable(); });

  $('#jsonpathInput').addEventListener('input', (ev)=>{ state.jsonpathExpr = ev.target.value; renderTable(); });

  $('#fieldSearch').addEventListener('input', renderFieldList);
  $('#selectAll').addEventListener('click', ()=>{ state.selectedFields = state.allFields.slice(); state.hiddenFields.clear(); rebuildColumnsOrder(); renderFieldList(); renderTable(); });
  $('#selectNone').addEventListener('click', ()=>{ state.selectedFields = []; state.hiddenFields = new Set(state.allFields); rebuildColumnsOrder(); renderFieldList(); renderTable(); });
  $('#selectCommon').addEventListener('click', ()=>{
    const prefs = ['id','email','name','display_name','created_at','updated_at'];
    state.selectedFields = state.allFields.filter(f=> prefs.some(p=> f.endsWith(p)) ).slice(0,6);
    state.hiddenFields.clear(); for(const f of state.allFields){ if(!state.selectedFields.includes(f)) state.hiddenFields.add(f); }
    rebuildColumnsOrder(); renderFieldList(); renderTable();
  });

  $('#explodeToggle').addEventListener('change', (ev)=>{ state.explode = ev.target.checked; renderTable(); setStep(3); });

  $('#exportCsv').addEventListener('click', exportCSV);
  $('#resetAll').addEventListener('click', ()=>{ location.reload(); });

  // Check JSONPath availability
  (function(){
    const jpFunc = (window.JSONPath && window.JSONPath.JSONPath) ? window.JSONPath.JSONPath : window.JSONPath;
    $('#jpAvail').textContent = (typeof jpFunc==='function')? 'available' : 'unavailable';
  })();
})();
</script>
</body>
</html>
